import TaskList from "../components/TaskList";
import { useEffect, useState } from "react";
import { onboardingAPI } from "../services/api";
import NotificationList from "../components/NotificationList";
import { useNavigate } from "react-router-dom";

export default function EmployeeDashboard() {
  const [onboardings, setOnboardings] = useState([]);
  const [notifications, setNotifications] = useState([]);
  const [updateNote, setUpdateNote] = useState("");
  const [selectedOnboarding, setSelectedOnboarding] = useState(null);
  const [projectStatusDraft, setProjectStatusDraft] = useState({});
  const [uploading, setUploading] = useState(false);
  const navigate = useNavigate();
  const employeeId = localStorage.getItem("userId");
  const userName = localStorage.getItem("userName") || "Employee";

  const userRole = localStorage.getItem("role");

  useEffect(() => {
    // Check authentication
    if (!employeeId || !userRole || userRole.toUpperCase() !== "EMPLOYEE") {
      navigate("/");
      return;
    }
    
    loadOnboardings();
    loadNotifications();
  }, [employeeId, navigate]);

  const loadOnboardings = () => {
    if (!employeeId) return;
    onboardingAPI.get(`/employee/${employeeId}`)
      .then(res => setOnboardings(res.data))
      .catch(err => console.error("Failed to load onboardings:", err));
  };

  const loadNotifications = () => {
    if (employeeId) {
      onboardingAPI.get(`/notifications/${employeeId}`)
        .then(res => setNotifications(res.data))
        .catch(err => console.error("Failed to load notifications:", err));
    }
  };

  const postUpdate = async (onboardingId) => {
    if (!updateNote.trim()) {
      alert("Please enter an update note");
      return;
    }
    try {
      await onboardingAPI.post('/update', { onboardingId, employeeId, note: updateNote });
      alert('Update posted successfully');
      setUpdateNote("");
      setSelectedOnboarding(null);
      loadOnboardings();
      loadNotifications();
    } catch (err) {
      console.error(err);
      alert('Failed to post update');
    }
  };

  const updateProjectStatus = async (onboardingId, status) => {
    try {
      await onboardingAPI.put(`/${onboardingId}/project-status`, {
        employeeId,
        projectStatus: status
      });
      loadOnboardings();
      loadNotifications();
    } catch (err) {
      console.error(err);
      alert("Failed to update project status");
    }
  };

  const uploadDocuments = async (onboardingId, files) => {
    if (!files || files.length === 0) return;
    try {
      setUploading(true);
      const form = new FormData();
      form.append("employeeId", employeeId);
      Array.from(files).forEach(f => form.append("documents", f));
      await onboardingAPI.post(`/${onboardingId}/documents`, form, {
        headers: { "Content-Type": "multipart/form-data" }
      });
      alert("Documents uploaded");
      loadOnboardings();
      loadNotifications();
    } catch (err) {
      console.error(err);
      alert("Failed to upload documents");
    } finally {
      setUploading(false);
    }
  };

  const handleLogout = () => {
    localStorage.clear();
    navigate("/");
  };

  const getStatusColor = (status) => {
    switch (status) {
      case "approved": return "#4CAF50";
      case "rejected": return "#F44336";
      case "pending": return "#FF9800";
      default: return "#757575";
    }
  };

  if (!employeeId) {
    return (
      <div style={{ padding: "20px" }}>
        <h2>Employee Dashboard</h2>
        <p>Please login to access your dashboard.</p>
        <button onClick={() => navigate("/")}>Go to Login</button>
      </div>
    );
  }

  return (
    <div style={{ padding: "20px", maxWidth: "1200px", margin: "0 auto" }}>
      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: "20px" }}>
        <h2>Employee Dashboard</h2>
        <div>
          <span style={{ marginRight: "10px" }}>Welcome, {userName}</span>
          <button onClick={handleLogout}>Logout</button>
        </div>
      </div>

      <div style={{ marginBottom: "20px", padding: "10px", backgroundColor: "#e3f2fd", borderRadius: "5px" }}>
        <strong>Notifications ({notifications.filter(n => !n.isRead).length} unread)</strong>
        <NotificationList notifications={notifications.slice(0, 5)} onNotificationRead={loadNotifications} />
      </div>

      {onboardings.length === 0 && (
        <div style={{ padding: "20px", textAlign: "center", color: "#666" }}>
          <p>No onboarding workflows assigned yet.</p>
        </div>
      )}

      {onboardings.map(o => (
        <div key={o._id} style={{ border: '1px solid #ccc', padding: 20, marginBottom: 20, borderRadius: "5px", backgroundColor: "#fff" }}>
          <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: "15px" }}>
            <div>
              <h3 style={{ margin: 0 }}>{o.workflowTemplateId?.name || "Onboarding Workflow"}</h3>
              {o.workflowTemplateId?.description && (
                <p style={{ margin: "5px 0", color: "#666" }}>{o.workflowTemplateId.description}</p>
              )}
            </div>
            <span style={{ 
              padding: "5px 15px", 
              borderRadius: "4px", 
              backgroundColor: o.status === "active" ? "#2196F3" : o.status === "completed" ? "#4CAF50" : "#F44336",
              color: "white",
              fontSize: "14px"
            }}>
              {o.status?.toUpperCase() || "ACTIVE"}
            </span>
          </div>

          <div style={{ marginBottom: "15px" }}>
            <strong>Progress: {o.progress}%</strong>
            <div style={{ width: "100%", backgroundColor: "#e0e0e0", borderRadius: "4px", marginTop: "5px", height: "25px" }}>
              <div style={{ 
                width: `${o.progress}%`, 
                backgroundColor: "#4CAF50", 
                height: "100%", 
                borderRadius: "4px",
                transition: "width 0.3s",
                display: "flex",
                alignItems: "center",
                justifyContent: "center",
                color: "white",
                fontSize: "12px"
              }}>
                {o.progress}%
              </div>
            </div>
          </div>

          <div style={{ display: "flex", gap: "30px", marginBottom: "15px", flexWrap: "wrap" }}>
            <div>
              <strong>Started:</strong> {new Date(o.startedAt).toLocaleDateString()}
            </div>
            {o.deadline && (
              <div>
                <strong>Deadline:</strong> {new Date(o.deadline).toLocaleDateString()}
                {o.timeRemainingDays !== null && (
                  <span style={{ 
                    marginLeft: "10px", 
                    color: o.timeRemainingDays < 0 ? "#F44336" : o.timeRemainingDays < 3 ? "#FF9800" : "#4CAF50",
                    fontWeight: "bold"
                  }}>
                    ({o.timeRemainingDays > 0 ? `${o.timeRemainingDays} days remaining` : `${Math.abs(o.timeRemainingDays)} days overdue`})
                  </span>
                )}
              </div>
            )}
            {o.managerId && (
              <div>
                <strong>Manager:</strong> {o.managerId?.name || o.managerId?.email || "Assigned"}
              </div>
            )}
          </div>

          <div style={{ marginBottom: "15px", padding: "15px", backgroundColor: "#f5f5f5", borderRadius: "5px" }}>
            <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", flexWrap: "wrap", gap: "10px" }}>
              <strong>Project: {o.workflowTemplateId?.name || "Assigned Project"}</strong>
              <div style={{ display: "flex", alignItems: "center", gap: "10px" }}>
                <span style={{ fontWeight: "bold" }}>Status:</span>
                <select
                  value={projectStatusDraft[o._id] ?? o.projectStatus ?? "pending"}
                  onChange={(e) => {
                    const v = e.target.value;
                    setProjectStatusDraft(prev => ({ ...prev, [o._id]: v }));
                    updateProjectStatus(o._id, v);
                  }}
                  style={{ padding: "8px", borderRadius: "4px", border: "1px solid #ccc" }}
                >
                  <option value="started">Started</option>
                  <option value="pending">Pending</option>
                  <option value="ongoing">Ongoing</option>
                  <option value="completed">Completed</option>
                </select>
              </div>
            </div>

            {o.projectStatus === "completed" && (
              <div style={{ marginTop: "12px" }}>
                <div style={{ marginBottom: "8px" }}>
                  <strong>Upload completion documents:</strong>
                </div>
                <input
                  type="file"
                  multiple
                  onChange={(e) => uploadDocuments(o._id, e.target.files)}
                  disabled={uploading}
                />
                {uploading && <div style={{ marginTop: "6px", color: "#666" }}>Uploading...</div>}
                {o.completionReview && (
                  <div style={{ marginTop: "10px" }}>
                    <strong>Review:</strong> {o.completionReview.status?.toUpperCase() || "PENDING"}
                    {o.completionReview.remark && (
                      <div style={{ marginTop: "5px", color: "#666" }}>
                        Remark: {o.completionReview.remark}
                      </div>
                    )}
                  </div>
                )}
              </div>
            )}

            {o.documents && o.documents.length > 0 && (
              <div style={{ marginTop: "12px" }}>
                <strong>Uploaded Documents:</strong>
                <ul style={{ marginTop: "6px" }}>
                  {o.documents.map((d, idx) => (
                    <li key={idx}>
                      <a
                        href={`http://localhost:4002${d.url}`}
                        target="_blank"
                        rel="noreferrer"
                      >
                        {d.originalName || d.fileName}
                      </a>
                      <span style={{ marginLeft: "8px", fontSize: "12px", color: "#666" }}>
                        ({new Date(d.uploadedAt).toLocaleString()})
                      </span>
                    </li>
                  ))}
                </ul>
              </div>
            )}
          </div>

          <div style={{ marginBottom: "15px" }}>
            <strong>Tasks:</strong>
            <TaskList tasks={o.tasks} />
          </div>

          <div style={{ marginBottom: "15px", padding: "15px", backgroundColor: "#f5f5f5", borderRadius: "5px" }}>
            <strong>Post Daily Update:</strong>
            {selectedOnboarding === o._id ? (
              <div style={{ marginTop: "10px" }}>
                <textarea
                  value={updateNote}
                  onChange={(e) => setUpdateNote(e.target.value)}
                  placeholder="Enter your daily progress update..."
                  style={{ 
                    width: "100%", 
                    minHeight: "80px", 
                    padding: "10px", 
                    borderRadius: "4px",
                    border: "1px solid #ccc",
                    fontFamily: "inherit"
                  }}
                />
                <div style={{ marginTop: "10px" }}>
                  <button 
                    onClick={() => postUpdate(o._id)}
                    style={{ 
                      padding: "8px 16px", 
                      backgroundColor: "#4CAF50", 
                      color: "white", 
                      border: "none", 
                      borderRadius: "4px",
                      cursor: "pointer",
                      marginRight: "10px"
                    }}
                  >
                    Submit Update
                  </button>
                  <button 
                    onClick={() => {
                      setSelectedOnboarding(null);
                      setUpdateNote("");
                    }}
                    style={{ 
                      padding: "8px 16px", 
                      backgroundColor: "#757575", 
                      color: "white", 
                      border: "none", 
                      borderRadius: "4px",
                      cursor: "pointer"
                    }}
                  >
                    Cancel
                  </button>
                </div>
              </div>
            ) : (
              <button 
                onClick={() => setSelectedOnboarding(o._id)}
                style={{ 
                  marginTop: "10px",
                  padding: "8px 16px", 
                  backgroundColor: "#2196F3", 
                  color: "white", 
                  border: "none", 
                  borderRadius: "4px",
                  cursor: "pointer"
                }}
              >
                Post Daily Update
              </button>
            )}
          </div>

          <div>
            <strong>Daily Updates ({o.updates?.length || 0}):</strong>
            {o.updates && o.updates.length > 0 ? (
              <ul style={{ marginTop: "10px", listStyle: "none", padding: 0 }}>
                {o.updates.map((u, i) => (
                  <li key={i} style={{ 
                    marginTop: "10px", 
                    padding: "10px", 
                    backgroundColor: "#fff", 
                    borderRadius: "4px",
                    border: "1px solid #e0e0e0"
                  }}>
                    <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: "5px" }}>
                      <div style={{ fontSize: "12px", color: "#666" }}>
                        {new Date(u.date).toLocaleString()}
                      </div>
                      <span style={{ 
                        padding: "3px 8px", 
                        borderRadius: "3px",
                        backgroundColor: getStatusColor(u.status),
                        color: "white",
                        fontSize: "11px"
                      }}>
                        {u.status?.toUpperCase() || "PENDING"}
                      </span>
                    </div>
                    <div style={{ marginTop: "5px" }}>{u.note}</div>
                    {u.managerComment && (
                      <div style={{ 
                        marginTop: "8px", 
                        padding: "8px", 
                        backgroundColor: "#fff3cd", 
                        borderRadius: "4px",
                        fontSize: "13px",
                        borderLeft: "3px solid #ffc107"
                      }}>
                        <strong>Manager Comment:</strong> {u.managerComment}
                        {u.reviewedAt && (
                          <div style={{ fontSize: "11px", color: "#666", marginTop: "3px" }}>
                            Reviewed on {new Date(u.reviewedAt).toLocaleString()}
                          </div>
                        )}
                      </div>
                    )}
                  </li>
                ))}
              </ul>
            ) : (
              <p style={{ color: "#999", marginTop: "10px" }}>No updates posted yet</p>
            )}
          </div>
        </div>
      ))}
    </div>
  );
}